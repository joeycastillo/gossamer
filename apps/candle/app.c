#include "app.h"
#include "delay.h"
#include "tcc.h"
#include "tc.h"

void app_init(void) {
}

void app_setup(void) {
    // red and white pins are floating, which means the NMOS output can float.
    // pull these lines low first thing.
    HAL_GPIO_WARM_WHITE_out();
    HAL_GPIO_COOL_WHITE_out();
    HAL_GPIO_WARM_WHITE_clr();
    HAL_GPIO_COOL_WHITE_clr();

    // configure LEDs as outputs
    HAL_GPIO_RED1_out();
    HAL_GPIO_RED2_out();
    HAL_GPIO_RED3_out();
    HAL_GPIO_GREEN1_out();
    HAL_GPIO_GREEN2_out();
    HAL_GPIO_GREEN3_out();

    // and drive them high to turn off all LEDs.
    HAL_GPIO_RED1_set();
    HAL_GPIO_RED2_set();
    HAL_GPIO_RED3_set();
    HAL_GPIO_GREEN1_set();
    HAL_GPIO_GREEN2_set();
    HAL_GPIO_GREEN3_set();

    // configure TCC0 to drive red/green LED pins
    tcc_setup(0, 2);
    HAL_GPIO_RED1_pmuxen(HAL_GPIO_PMUX_F);
    HAL_GPIO_RED2_pmuxen(HAL_GPIO_PMUX_F);
    HAL_GPIO_RED3_pmuxen(HAL_GPIO_PMUX_F);
    HAL_GPIO_GREEN1_pmuxen(HAL_GPIO_PMUX_F);
    HAL_GPIO_GREEN2_pmuxen(HAL_GPIO_PMUX_F);
    HAL_GPIO_GREEN3_pmuxen(HAL_GPIO_PMUX_F);

    TCC0->WAVE.bit.WAVEGEN = TCC_WAVE_WAVEGEN_NPWM_Val;
    TCC0->PER.reg = 256;
    TCC0->WEXCTRL.bit.OTMX = 1;
    TCC0->DRVCTRL.reg |= TCC_DRVCTRL_INVEN_Msk;
    TCC0->CTRLA.bit.RUNSTDBY = 1;
    tcc_enable(0);

    // Red/green LEDs are numbered clockwise from top,
    // and driven using the TCC peripheral

    // with OTMX 0:
    // CC[0] controls GREEN1 and GREEN3
    // CC[1] controls RED1 and RED3
    // CC[2] controls GREEN2
    // CC[3] controls RED2

    // with OTMX 1:
    // CC[0] controls all green LEDs
    // CC[1] controls all red LEDs

    // with OTMX 2:
    // CC[0] controls all LEDs together (three yellow LEDs)

    TCC0->CC[0].reg = 85;
    TCC0->CC[1].reg = 255;

    tc_setup(1, 2);
    HAL_GPIO_WARM_WHITE_pmuxen(HAL_GPIO_PMUX_E);
    HAL_GPIO_COOL_WHITE_pmuxen(HAL_GPIO_PMUX_E);

    TC1->COUNT8.CTRLA.bit.MODE = TC_CTRLA_MODE_COUNT8_Val;
    TC1->COUNT8.CTRLA.bit.WAVEGEN = TC_CTRLA_WAVEGEN_NPWM_Val;
    TC1->COUNT8.CTRLA.bit.RUNSTDBY = 1;
    tc_enable(1);

    // White LEDs are driven using the TC1 peripheral.
    // CC[0] controls warm white LED
    // CC[1] controls cool white LED

    TC1->COUNT8.CC[0].reg = 32;
    TC1->COUNT8.CC[1].reg = 0;
}

static const uint8_t flicker[] = {247, 97, 22, 222, 172, 243, 172, 66, 212, 240, 181, 178, 66, 73, 175, 35, 56, 67, 7, 151, 255, 97, 152, 110, 22, 16, 136, 20, 132, 138, 92, 186, 24, 40, 233, 5, 54, 215, 187, 153, 122, 77, 138, 220, 36, 5, 213, 34, 25, 62, 88, 44, 48, 202, 55, 230, 113, 201, 30, 239, 13, 31, 182, 240, 96, 73, 179, 40, 151, 181, 150, 37, 155, 67, 133, 224, 99, 173, 37, 78, 2, 40, 249, 184, 247, 172, 11, 44, 49, 248, 185, 62, 63, 154, 129, 182, 188, 121, 21, 112, 39, 151, 239, 188, 137, 15, 142, 225, 179, 115, 63, 200, 170, 243, 13, 172, 169, 52, 127, 104, 167, 10, 207, 113, 18, 237, 77, 106, 82, 69, 199, 102, 62, 199, 25, 79, 173, 200, 244, 186, 173, 241, 140, 173, 159, 162, 237, 100, 41, 191, 81, 60, 254, 238, 57, 148, 227, 219, 143, 59, 255, 248, 39, 238, 55, 73, 86, 94, 81, 162, 39, 172, 171, 253, 79, 22, 179, 108, 222, 135, 90, 59, 129, 104, 115, 47, 43, 21, 34, 222, 73, 83, 18, 62, 83, 104, 15, 158, 47, 158, 184, 49, 74, 52, 92, 30, 164, 214, 145, 180, 94, 166, 146, 164, 219, 97, 73, 51, 242, 184, 171, 88, 62, 59, 28, 155, 88, 64, 202, 223, 6, 159, 146, 218, 235, 225, 85, 197, 122, 80, 207, 152, 157, 158, 4, 117, 186, 126, 239, 8, 201, 157, 158, 191, 234, 35, 250, 24, 116, 64, 176, 59, 78, 118, 146, 243, 253, 183, 218, 128, 127, 205, 101, 250, 183, 90, 22, 146, 31, 144, 83, 108, 141, 113, 223, 202, 143, 160, 74, 67, 118, 208, 209, 71, 246, 42, 221, 102, 229, 197, 10, 122, 110, 108, 66, 81, 97, 94, 236, 116, 108, 205, 138, 220, 222, 15, 215, 167, 4, 203, 189, 109, 162, 243, 96, 239, 134, 158, 209, 91, 41, 109, 92, 90, 202, 239, 203, 25, 5, 172, 52, 5, 26, 206, 153, 14, 240, 222, 229, 162, 63, 113, 121, 63, 246, 47, 32, 144, 113, 235, 67, 175, 72, 147, 192, 125, 96, 216, 26, 30, 50, 78, 84, 57, 16, 173, 179, 208, 116, 209, 125, 248, 44, 223, 150, 121, 176, 86, 246, 213, 106, 182, 140, 56, 109, 253, 196, 251, 26, 95, 68, 133, 153, 206, 249, 165, 28, 160, 150, 114, 61, 122, 4, 141, 22, 163, 40, 224, 78, 208, 15, 18, 91, 148, 242, 103, 66, 166, 29, 4, 180, 133, 222, 228, 222, 167, 25, 4, 230, 243, 96, 240, 179, 219, 14, 11, 79, 254, 180, 166, 72, 155, 196, 44, 77, 234, 209, 115, 24, 85, 34, 200, 144, 225, 155, 246, 68, 226, 224, 32, 13, 83, 105, 226, 169, 37, 150, 41, 38, 184, 83, 12, 169, 93, 225, 218, 185, 216, 140, 187, 10, 3, 41, 244, 245, 226, 141, 254, 149, 243, 105, 58, 151, 222, 220, 95, 24, 97, 146, 104, 196, 94, 170, 147, 43, 60, 19, 16, 198, 195, 187, 35, 11, 21, 45, 208, 19, 192, 49, 97, 247, 158, 210, 165, 66, 74, 54, 71, 165, 111, 175, 227, 142, 112, 239, 219, 80, 68, 120, 151, 4, 36, 18, 26, 201, 145, 74, 120, 246, 195, 49, 5, 175, 197, 19, 224, 111, 172, 189, 2, 244, 6, 60, 224, 82, 33, 78, 215, 243, 187, 19, 247, 207, 52, 216, 7, 236, 102, 43, 162, 95, 118, 80, 47, 92, 150, 99, 114, 39, 169, 243, 144, 124, 216, 4, 72, 222, 239, 223, 180, 152, 68, 159, 96, 114, 31, 214, 231, 225, 126, 49, 238, 232, 111, 11, 157, 51, 109, 235, 174, 4, 180, 29, 62, 181, 94, 128, 224, 14, 62, 85, 97, 137, 207, 174, 41, 7, 189, 93, 175, 148, 235, 236, 87, 246, 27, 237, 247, 178, 118, 29, 121, 255, 183, 79, 124, 215, 33, 212, 22, 242, 248, 64, 25, 22, 237, 126, 149, 208, 97, 186, 61, 175, 2, 182, 32, 189, 17, 130, 231, 4, 128, 31, 89, 251, 35, 176, 142, 99, 122, 105, 115, 148, 215, 211, 12, 230, 12, 201, 127, 223, 145, 239, 104, 145, 108, 173, 74, 159, 89, 249, 248, 53, 168, 72, 212, 18, 129, 178, 148, 105, 98, 14, 202, 213, 212, 205, 44, 59, 140, 68, 35, 71, 194, 176, 228, 228, 169, 212, 105, 85, 171, 31, 50, 176, 243, 33, 150, 188, 105, 99, 57, 245, 163, 77, 156, 18, 111, 132, 59, 235, 241, 14, 140, 48, 108, 31, 255, 132, 143, 219, 33, 164, 62, 43, 57, 106, 29, 63, 188, 117, 165, 233, 9, 69, 98, 166, 97, 231, 248, 66, 123, 83, 133, 240, 152, 56, 150, 109, 249, 95, 22, 39, 116, 16, 89, 86, 44, 199, 47, 254, 125, 148, 45, 181, 144, 104, 156, 150, 100, 222, 146, 218, 227, 22, 119, 84, 70, 45, 135, 80, 244, 167, 21, 62, 131, 233, 117, 14, 179, 96, 83, 32, 167, 247, 32, 62, 154, 11, 172, 225, 187, 4, 145, 26, 217, 223, 121, 175, 192, 120, 190, 71, 185, 174, 30, 61, 246, 117, 37, 144, 36, 224, 200, 155, 94, 239, 253, 59, 157, 77, 191, 153, 28, 122, 55, 62, 181, 109, 156, 50, 183, 78, 7, 240, 69, 157, 31, 96, 34, 61, 81, 89, 22, 250, 114, 238, 131, 218, 5, 72, 209, 77, 6, 76, 21, 40, 42, 64, 109, 99, 174, 126, 221, 133, 90, 207, 207, 84, 84, 243, 126, 188, 131, 151, 126, 246, 237, 231, 240, 225, 105, 181, 100, 248, 99, 156, 40, 186, 110, 201, 70, 120, 127, 116, 110, 106, 97, 45, 241, 234, 10, 127, 164, 234, 181, 188, 56, 198, 103, 45, 130, 250, 188, 109, 178, 48, 249, 88, 180, 93, 83, 244, 191, 178, 249, 52, 140, 150, 231};
int i = 0;

bool app_loop(void) {
    TCC0->CC[0].reg = flicker[i] / 3;
    TCC0->CC[1].reg = flicker[i];
    TC1->COUNT8.CC[0].reg = flicker[++i] / 8;
    i = i % sizeof(flicker);
    delay_ms(50);

    return false;
}
