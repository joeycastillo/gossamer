#include "app.h"
#include "tc.h"
#include "dac.h"
#include "dma.h"
#include "system.h"
#include <math.h>

static const uint16_t sine_vals[] = {
    0x200,0x206,0x20c,0x212,0x219,0x21f,0x225,0x22b,0x232,0x238,0x23e,0x244,0x24b,0x251,0x257,0x25d,0x263,0x269,0x270,0x276,0x27c,0x282,0x288,0x28e,0x294,0x29a,0x2a0,0x2a6,0x2ac,0x2b2,0x2b8,0x2bd,0x2c3,0x2c9,0x2cf,0x2d5,0x2da,0x2e0,0x2e5,0x2eb,0x2f1,0x2f6,0x2fc,0x301,0x306,0x30c,0x311,0x316,0x31c,0x321,0x326,0x32b,0x330,0x335,0x33a,0x33f,0x344,0x349,0x34e,0x352,0x357,0x35c,0x360,0x365,0x369,0x36e,0x372,0x376,0x37a,0x37f,0x383,0x387,0x38b,0x38f,0x393,0x397,0x39a,0x39e,0x3a2,0x3a5,0x3a9,0x3ac,0x3b0,0x3b3,0x3b6,0x3b9,0x3bd,0x3c0,0x3c3,0x3c6,0x3c8,0x3cb,0x3ce,0x3d1,0x3d3,0x3d6,0x3d8,0x3da,0x3dd,0x3df,0x3e1,0x3e3,0x3e5,0x3e7,0x3e9,0x3eb,0x3ec,0x3ee,0x3f0,0x3f1,0x3f3,0x3f4,0x3f5,0x3f6,0x3f7,0x3f9,0x3f9,0x3fa,0x3fb,0x3fc,0x3fd,0x3fd,0x3fe,0x3fe,0x3fe,0x3ff,0x3ff,0x3ff,
    0x3ff,0x3ff,0x3ff,0x3ff,0x3fe,0x3fe,0x3fe,0x3fd,0x3fd,0x3fc,0x3fb,0x3fa,0x3f9,0x3f9,0x3f7,0x3f6,0x3f5,0x3f4,0x3f3,0x3f1,0x3f0,0x3ee,0x3ec,0x3eb,0x3e9,0x3e7,0x3e5,0x3e3,0x3e1,0x3df,0x3dd,0x3da,0x3d8,0x3d6,0x3d3,0x3d1,0x3ce,0x3cb,0x3c8,0x3c6,0x3c3,0x3c0,0x3bd,0x3b9,0x3b6,0x3b3,0x3b0,0x3ac,0x3a9,0x3a5,0x3a2,0x39e,0x39a,0x397,0x393,0x38f,0x38b,0x387,0x383,0x37f,0x37a,0x376,0x372,0x36e,0x369,0x365,0x360,0x35c,0x357,0x352,0x34e,0x349,0x344,0x33f,0x33a,0x335,0x330,0x32b,0x326,0x321,0x31c,0x316,0x311,0x30c,0x306,0x301,0x2fc,0x2f6,0x2f1,0x2eb,0x2e5,0x2e0,0x2da,0x2d5,0x2cf,0x2c9,0x2c3,0x2bd,0x2b8,0x2b2,0x2ac,0x2a6,0x2a0,0x29a,0x294,0x28e,0x288,0x282,0x27c,0x276,0x270,0x269,0x263,0x25d,0x257,0x251,0x24b,0x244,0x23e,0x238,0x232,0x22b,0x225,0x21f,0x219,0x212,0x20c,0x206,
    0x200,0x1f9,0x1f3,0x1ed,0x1e6,0x1e0,0x1da,0x1d4,0x1cd,0x1c7,0x1c1,0x1bb,0x1b4,0x1ae,0x1a8,0x1a2,0x19c,0x196,0x18f,0x189,0x183,0x17d,0x177,0x171,0x16b,0x165,0x15f,0x159,0x153,0x14d,0x147,0x142,0x13c,0x136,0x130,0x12a,0x125,0x11f,0x11a,0x114,0x10e,0x109,0x103,0xfe,0xf9,0xf3,0xee,0xe9,0xe3,0xde,0xd9,0xd4,0xcf,0xca,0xc5,0xc0,0xbb,0xb6,0xb1,0xad,0xa8,0xa3,0x9f,0x9a,0x96,0x91,0x8d,0x89,0x85,0x80,0x7c,0x78,0x74,0x70,0x6c,0x68,0x65,0x61,0x5d,0x5a,0x56,0x53,0x4f,0x4c,0x49,0x46,0x42,0x3f,0x3c,0x39,0x37,0x34,0x31,0x2e,0x2c,0x29,0x27,0x25,0x22,0x20,0x1e,0x1c,0x1a,0x18,0x16,0x14,0x13,0x11,0xf,0xe,0xc,0xb,0xa,0x9,0x8,0x6,0x6,0x5,0x4,0x3,0x2,0x2,0x1,0x1,0x1,0x0,0x0,0x0,
    0x0,0x0,0x0,0x0,0x1,0x1,0x1,0x2,0x2,0x3,0x4,0x5,0x6,0x6,0x8,0x9,0xa,0xb,0xc,0xe,0xf,0x11,0x13,0x14,0x16,0x18,0x1a,0x1c,0x1e,0x20,0x22,0x25,0x27,0x29,0x2c,0x2e,0x31,0x34,0x37,0x39,0x3c,0x3f,0x42,0x46,0x49,0x4c,0x4f,0x53,0x56,0x5a,0x5d,0x61,0x65,0x68,0x6c,0x70,0x74,0x78,0x7c,0x80,0x85,0x89,0x8d,0x91,0x96,0x9a,0x9f,0xa3,0xa8,0xad,0xb1,0xb6,0xbb,0xc0,0xc5,0xca,0xcf,0xd4,0xd9,0xde,0xe3,0xe9,0xee,0xf3,0xf9,0xfe,0x103,0x109,0x10e,0x114,0x11a,0x11f,0x125,0x12a,0x130,0x136,0x13c,0x142,0x147,0x14d,0x153,0x159,0x15f,0x165,0x16b,0x171,0x177,0x17d,0x183,0x189,0x18f,0x196,0x19c,0x1a2,0x1a8,0x1ae,0x1b4,0x1bb,0x1c1,0x1c7,0x1cd,0x1d4,0x1da,0x1e0,0x1e6,0x1ed,0x1f3,0x1f9,
};

void app_init(void) {
}

void app_setup(void) {
    HAL_GPIO_A0_pmuxen(HAL_GPIO_PMUX_B);
    dac_init();
    dac_enable(0);

    tc_init(4, GENERIC_CLOCK_0, TC_PRESCALER_DIV1);
    tc_set_wavegen(4, TC_WAVEGEN_MATCH_FREQUENCY);
    tc_count16_set_cc(4, 0, 20);
    tc_enable(4);

    gossamer_dma_job_t dac_dma;
    dma_init();
    dma_configure(&dac_dma,
                  TC4_DMAC_ID_OVF,
                  DMA_TRIGGER_ACTION_BEAT,
                  DMA_CONFIG_LOOP);
    dma_add_descriptor(&dac_dma,
                       (void *)sine_vals,
                       (void *)&DAC->DATABUF.reg,
                       sizeof(sine_vals) / sizeof(sine_vals[0]),
                       DMA_BEAT_SIZE_HWORD,
                       DMA_INCREMENT_SOURCE,
                       DMA_STEPSIZE_1,
                       DMA_STEPSEL_SOURCE);
    dma_start_job(&dac_dma);
}

bool app_loop(void) {
    return false;
}
