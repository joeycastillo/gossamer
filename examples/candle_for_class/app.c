#include "app.h"
#include "delay.h"
#include "adc.h"
#include "tcc.h"
#include <stdint.h>

#define NUM_TEMPERATURE_SAMPLES (128)

uint16_t temperatures[NUM_TEMPERATURE_SAMPLES] = {0};
uint8_t tempindex = 0;

void candle_on(void);
void candle_advance_frame(void);
void candle_off(void);

const uint8_t values[] = {
16, 16, 16, 41, 74, 106, 133, 152, 158, 158, 160, 162, 164, 167, 169, 170, 171, 167, 157, 142, 123, 105, 90, 79, 76, 89, 127, 184, 251, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 237, 230, 236, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 231, 193, 167, 158, 155, 144, 129, 111, 92, 77, 66, 63, 61, 58, 54, 48, 43, 38, 35, 34, 48, 88, 147, 218, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 250, 246, 241, 226, 203, 176, 150, 127, 112, 106, 113, 131, 159, 191, 223, 251, 255, 255, 255, 248, 219, 184, 149, 119, 99, 92, 97, 110, 130, 153, 177, 196, 210, 214, 214, 211, 208, 204, 201, 197, 195, 195, 185, 157, 116, 67, 18, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 25, 34, 41, 43, 45, 49, 55, 62, 70, 76, 80, 82, 88, 104, 129, 158, 187, 212, 228, 234, 239, 252, 255, 255, 255, 255, 255, 255, 255, 255, 245, 175, 105, 46, 16, 16, 16, 16, 16, 16, 18, 24, 28, 29, 36, 54, 81, 113, 145, 172, 190, 197, 202, 218, 241, 255, 255, 255, 255, 255, 255, 255, 216, 139, 62, 16, 16, 16, 16, 16, 16, 47, 89, 125, 148, 157, 149, 128, 97, 60, 23, 16, 16, 16, 16, 16, 61, 121, 181, 232, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 223, 185, 160, 151, 151, 151, 152, 153, 154, 154, 155, 155, 153, 148, 141, 132, 123, 115, 110, 109, 115, 131, 156, 186, 215, 240, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 243, 214, 194, 188, 195, 215, 245, 255, 255, 255, 255, 255, 255, 255, 255, 210, 148, 95, 60, 47, 58, 88, 132, 185, 237, 255, 255, 255, 255, 255, 255, 255, 245, 227, 215, 210, 206, 195, 177, 157, 136, 119, 107, 103, 113, 141, 184, 234, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 246, 197, 147, 106, 78, 68, 71, 79, 90, 104, 118, 130, 138, 141, 140, 135, 129, 121, 113, 107, 103, 101, 99, 92, 83, 71, 59, 50, 43, 41, 51, 80, 123, 174, 225, 255, 255, 255, 255, 255, 232, 185, 139, 99, 73, 63, 67, 77, 92, 109, 126, 141, 151, 155, 150, 138, 119, 96, 74, 55, 42, 38, 52, 94, 156, 228, 255, 255, 255, 255, 255, 255, 255, 207, 126, 58, 16, 16, 16, 40, 89, 147, 204, 253, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 251, 215, 171, 128, 91, 66, 58, 60, 69, 81, 95, 109, 121, 129, 132, 125, 104, 73, 37, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 17, 96, 189, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 236, 204, 183, 176, 168, 144, 108, 65, 23, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 90, 184, 255, 255, 255, 255, 255, 255, 255, 242, 170, 109, 69, 54, 61, 81, 111, 146, 182, 212, 232, 239, 238, 237, 236, 234, 232, 231, 230, 229, 235, 251, 255, 255, 255, 255, 255, 255, 255, 255, 255, 225, 165, 115, 81, 70, 72, 78, 86, 97, 107, 116, 122, 124, 134, 162, 205, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 192, 115, 50, 16, 16, 16, 28, 69, 118, 167, 208, 236, 245, 239, 221, 195, 164, 132, 106, 88, 82, 82, 80, 79, 77, 75, 73, 72, 72, 80, 105, 141, 184, 227, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 233, 189, 145, 107, 82, 73, 76, 83, 94, 107, 120, 131, 139, 141, 152, 183, 229, 255, 255, 255, 255, 255, 255, 255, 255, 206, 122, 51, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 17, 62, 128, 207, 255, 255, 255, 255, 255, 255, 255, 217, 142, 78, 36, 21, 19, 16, 16, 16, 16, 16, 16, 16, 16, 16, 60, 112, 164, 208, 237, 248, 240, 219, 187, 149, 112, 80, 58, 51, 64, 101, 157, 223, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 253, 249, 246, 243, 241, 241, 234, 215, 186, 153, 119, 91, 72, 65, 75, 101, 142, 189, 237, 255, 255, 255, 255, 255, 222, 166, 110, 62, 30, 19, 33, 71, 128, 196, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 246, 241, 232, 208, 171, 128, 84, 48, 23, 16, 16, 16, 17, 18, 20, 21, 22, 22, 21, 18, 16, 16, 16, 16, 16, 16, 16, 33, 72, 119, 165, 205, 231, 240, 242, 246, 252, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 246, 234, 220, 206, 193, 185, 182, 186, 197, 213, 232, 251, 255, 255, 255, 255, 255, 242, 218, 193, 172, 158, 153, 160, 179, 208, 241, 255, 255, 255, 255, 255, 255, 255, 216, 172, 135, 111, 102, 110, 132, 166, 206, 246, 255, 255, 255, 255, 255, 255, 235, 206, 182, 165, 160, 156, 145, 129, 110, 91, 74, 64, 60, 68, 93, 129, 172, 216, 252, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 241, 198, 147, 97, 54, 25, 16, 20, 34, 55, 80, 105, 126, 140, 145, 144, 141, 137, 132, 128, 124, 121, 120, 117, 109, 98, 84, 70, 59, 51, 48, 62, 102, 161, 232, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 254, 246, 243, 239, 228, 211, 192, 172, 155, 144, 140, 148, 170, 203, 242, 255, 255, 255, 255, 255, 255, 255, 255, 222, 193, 174, 167, 169, 173, 179, 187, 195, 201, 205, 207, 209, 217, 228, 242, 255, 255, 255, 255, 255, 255, 255, 250, 240, 231, 225, 223, 223, 223, 222, 221, 221, 220, 220, 220, 223, 231, 243, 255, 255, 255, 255, 255, 255, 252, 204, 147, 90, 42, 16, 16, 16, 16, 16, 16, 21, 26, 29, 31, 41, 69, 112, 163, 214, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 203, 157, 126, 116, 120, 133, 152, 175, 197, 217, 229, 234, 230, 220, 205, 187, 169, 154, 144, 140, 149, 174, 211, 255, 255, 255, 255, 255, 255, 255, 255, 209, 148, 96, 61, 49, 64, 104, 165, 237, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 253, 195, 147, 114, 102, 100, 92, 80, 66, 52, 40, 32, 30, 36, 56, 85, 120, 154, 183, 203, 209, 208, 203, 197, 189, 181, 174, 170, 168, 165, 155, 141, 124, 107, 92, 83, 79, 85, 102, 128, 158, 188, 213, 230, 236, 238, 242, 249, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 245, 227, 206, 184, 166, 154, 149, 157, 179, 213, 253, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 237, 202, 160, 119, 83, 60, 51, 53, 56, 61, 67, 74, 79, 82, 83, 89, 106, 132, 162, 192, 217, 234, 240, 248, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 197, 143, 106, 93, 92, 89, 85, 79, 74, 69, 66, 65, 78, 114, 168, 232, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 209, 149, 99, 65, 53, 56, 65, 77, 92, 107, 120, 128, 131, 135, 146, 164, 184, 204, 221, 233, 237, 237, 235, 233, 231, 228, 226, 224, 224, 217, 196, 166, 130, 94, 63, 43, 36, 38, 42, 50, 58, 67, 74, 79, 80, 91, 122, 169, 224, 255, 255, 255, 255, 255, 255, 247, 173, 98, 34, 16, 16, 16, 16, 21, 48, 76, 99, 114, 120, 122, 129, 140, 153, 165, 176, 183, 186, 179, 158, 128, 93, 57, 27, 16, 16, 16, 37, 79, 129, 178, 220, 248, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 222, 196, 186, 194, 218, 253, 255, 255, 255, 255, 255, 255, 255, 255, 255, 217, 174, 145, 135, 131, 120, 105, 86, 68, 52, 42, 38, 35, 27, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 25, 32, 34, 47, 85, 142, 209, 255, 255, 255, 255, 255, 255, 255, 232, 174, 125, 92, 80, 85, 99, 120, 144, 168, 189, 203, 207, 212, 225, 244, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 236, 213, 198, 192, 192, 193, 193, 194, 195, 196, 196, 196, 196, 196, 196, 196, 196, 196, 195, 195, 192, 182, 166, 148, 130, 115, 105, 101, 110, 136, 174, 220, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 234, 190, 160, 150, 151, 153, 156, 160, 164, 167, 169, 170, 162, 140, 106, 67, 27, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 16, 43, 91, 148, 205, 253, 255, 255, 255, 253, 205, 148, 91, 44, 16, 16, 16, 60, 127, 205, 255, 255, 255, 255, 255, 255, 255, 174, 84, 16, 16, 16, 16, 16, 16, 49, 91, 127, 151, 159, 153, 137, 113, 84, 56, 31, 16, 16, 24, 67, 131, 207, 255, 255, 255, 255, 255, 255, 255, 229, 162, 105, 67, 53, 51, 44, 33, 20, 16, 16, 16, 16, 16, 37, 93, 159, 225, 255, 255, 255, 255, 255, 219, 150, 81, 22, 16, 16, 16, 21, 78, 145, 213, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 183, 109, 47, 16, 16, 16, 18, 47, 81, 116, 145, 164, 171, 173, 177, 183, 191, 199, 205, 209, 211, 202, 178, 143, 100, 58, 22, 16, 16, 16, 39, 92, 156, 219, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 194, 139, 102, 89, 96, 116, 146, 181, 216, 246, 255, 255, 255, 232, 187, 133, 80, 35, 16, 16, 16, 35, 81, 135, 188, 234, 255, 255, 255, 234, 188, 135, 81, 35, 16, 16, 16, 16, 34, 59, 84, 106, 120, 125, 132, 154, 186, 225, 255, 255, 255, 255, 255, 255, 255, 255, 230, 208, 193, 188, 196, 219, 254, 255, 255, 255, 255, 255, 255, 255, 255, 255, 200, 153, 121, 110, 115, 130, 153, 179, 205, 228, 243, 248, 238, 208, 165, 113, 62, 18, 16, 16, 16, 30, 87, 154, 220, 255, 255, 255, 255, 255, 228, 165, 103, 50, 16, 16, 16, 25, 49, 78, 107, 131, 148, 154, 149, 136, 117, 95, 72, 53, 41, 36, 46, 75, 118, 169, 220, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 252, 245, 243, 242, 238, 232, 225, 218, 212, 208, 207, 211, 221, 236, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 255, 221, 145, 81, 39, 23, 26, 31, 40, 50, 61, 69, 75, 77, 89, 124, 175, 236, 255, 255, 255, 255, 255, 255, 255, 255, 248, 214, 191    
};

void app_init(void) {
    // Configure the temperature sensor as an ADC input.
    HAL_GPIO_TEMPSENSE_pmuxen(HAL_GPIO_PMUX_ADC);
    // Initialize and enable the ADC.
    adc_init();
    adc_enable();
}

void app_setup(void) {
    // Fill the temperatures array with the current temperature.
    for (uint8_t i = 0; i < NUM_TEMPERATURE_SAMPLES; i++) {
        temperatures[i] = adc_get_analog_value(HAL_GPIO_TEMPSENSE_pin());
    }
}

bool app_loop(void) {
    // compute the average of the temperature samples.
    uint32_t average = 0;
    for (uint8_t i = 0; i < NUM_TEMPERATURE_SAMPLES; ++i) average += temperatures[i];
    average /= NUM_TEMPERATURE_SAMPLES;

    // now get the current temperature for comparison.
    uint16_t current_temp = adc_get_analog_value(HAL_GPIO_TEMPSENSE_pin());

    if (current_temp > (average + 500)) {
        // if the temperature has risen above the average, turn the candle on...
        candle_on();
        // ...and run it until the battery dies (or we press reset).
        while (true) {
            candle_advance_frame();
            delay_ms(20);
        }
    } else {
        // otherwise just add it to the array.
        temperatures[tempindex] = current_temp;
        tempindex = (tempindex + 1) % NUM_TEMPERATURE_SAMPLES;    
    }

    return false;
}

void candle_on(void) {
    // Make the LED pins digital outputs.
    HAL_GPIO_RED_out();
    HAL_GPIO_GREEN_out();
    HAL_GPIO_BLUE_out();

    // TCC0 is used to generate the PWM signals for the candle.
    tcc_init(0, GENERIC_CLOCK_0, TCC_PRESCALER_DIV1);
    // Normal PWM mode
    tcc_set_wavegen(0, TCC_WAVEGEN_NORMAL_PWM);
    // Period is 256, so a value of 128 is a 50% duty cycle.
    tcc_set_period(0, 256, false);
    // Enable the TCC.
    tcc_enable(0);

    // Connect the LED pins to the TCC so it can PWM them.
    HAL_GPIO_RED_pmuxen(HAL_GPIO_PMUX_TCC_ALT);
    HAL_GPIO_GREEN_pmuxen(HAL_GPIO_PMUX_TCC_ALT);
    HAL_GPIO_BLUE_pmuxen(HAL_GPIO_PMUX_TC_TCC);
}

void candle_advance_frame(void) {
    static uint32_t i = 0;

    // set red channel to the value for the current frame
    tcc_set_cc(0, 1, values[i], false);
    // set green channel to half the value for the current frame
    tcc_set_cc(0, 0, values[i] >> 1, false);

    // advance, and loop if we've reached the end of our array
    i = (i + 1) % sizeof(values);
}

void candle_off(void) {
    // disable the LED pins and disconnect them from the TCC
    HAL_GPIO_RED_off();
    HAL_GPIO_GREEN_off();
    HAL_GPIO_BLUE_off();
    HAL_GPIO_RED_pmuxdis();
    HAL_GPIO_GREEN_pmuxdis();
    HAL_GPIO_BLUE_pmuxdis();

    // disable the TCC
    tcc_disable(0);
}