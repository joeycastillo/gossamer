<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.5"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>gossamer: gossamer</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">gossamer<span id="projectnumber">&#160;0.0.0</span>
   </div>
   <div id="projectbrief">a very lightweight app framework for SAMD and SAML chips</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.5 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search/",'.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Loading...</div>
<div class="SRStatus" id="Searching">Searching...</div>
<div class="SRStatus" id="NoMatches">No Matches</div>
</div>
</div>
</div>
</div>

<div><div class="header">
  <div class="headertitle"><div class="title">gossamer </div></div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1><a class="anchor" id="autotoc_md0"></a>
gossamer: a very lightweight firmware framework for SAMD and SAML chips</h1>
<blockquote class="doxtable">
<p >&zwj;gos·sa·mer noun <br  />
 \ ˈgä-sə-mər \ <br  />
</p>
<ol type="1">
<li>a film of cobwebs floating in air in calm clear weather <br  />
</li>
<li>something light, delicate, or insubstantial </li>
</ol>
</blockquote>
<p>gossamer is an extremely lightweight framework for developing bare-metal firmware applications for the Microchip (neé Atmel) SAM D and SAM L series chips. it aims for consistency, simplicity and low power consumption.</p>
<p ><b>STILL UNDER ACTIVE DEVELOPMENT!</b> The API remains likely to change for the foreseeable future.</p>
<p >Gossamer targets four chips at this time: the SAM D11, D21, L21 and L22. These chips are all strikingly similar: they all have Cortex M0+ cores as well as native USB and as familiar peripherals like ADC's, TCC's and SERCOMs. Alas, a lot of the interfaces to these peripherals have slight differences, and at startup, these chips have subtly different clock setups.</p>
<p >The primary goal of the project is to provide a simple environment for making device firmware for gadgets aieh these chips. The secondary goal is to ensure that the code you write can be compatible across chips in the family. By papering over subtle differences in syntax and setup, you should be able to write code for one chip in the family (like the SAM D21), and then seamlessly compile it for another, like the SAM D11 if you realize you need to cut BOM costs, or the L21 if you decide that low power is your priority.</p>
<p >Not all devices have all the same peripherals. Some features, like the segment LCD, are specific to one chip like the SAM L22. Even some devices that do have the same peripherals have different configuration options; for example, the DAC peripheral has two 12-bit channels on the SAM L21, but only one 10-bit channel on the SAM D21 and D11. Still, many of the peripherals are very similar on the different platforms, and gossamer provides a thin layer of translation on top that should make it easy to move up and down the product line.</p>
<h2><a class="anchor" id="autotoc_md1"></a>
A consistent setup at boot</h2>
<p >If you look at the data sheet, you'll see that some devices boot with a 1 MHz clock, and others with a 4 MHz clock. No generic clocks are defined, and if you're coming from the Atmel Start world, you'll recall that it was on you to invent a clock tree from sceatch.</p>
<p >Gossamer simplifies this by giving you a consistent environment on all four platforms:</p>
<ul>
<li>GCLK0, the main system clock, is set to 8 MHz at boot. You can change this in <code>app_init</code> using the <code>set_cpu_frequency</code> function.</li>
<li>GCLK2 is a low-power, low-accuracy 32 kHz clock sourced from OSCULP32K.</li>
<li>GCLK3 is a 1024 Hz clock, derived from the most accurate source available.</li>
</ul>
<p >Some peripherals are automatically clocked from the source that makes the most sense (i.e. RTC from GCLK3, EIC from GCLK2). SERCOM peripherals are clocked from the main clock, but provide a configurable baud rate in theor init functions. More versatile peripherals like the TC and TCC take a generic clock and prescaler factor as parameters in their init functions.</p>
<h2><a class="anchor" id="autotoc_md2"></a>
Consistent interface to peripherals</h2>
<p >Peripherals are generally thin wrappers around the actual hardware, and provide a consistent way to enable, disable and operate the peripherals. This allows us to paper over subtle implementation details and hand-wave away register layout differences, like the difference between waiting on <code>STATUS.bit.SYNCBUSY</code> vs <code>SYNCBUSY.reg</code>.</p>
<p >All peripherals (WIP) have a <code>peripheral_init</code> and a <code>peripheral_enable</code> function, as well as a <code>peripheral_disable</code> function.</p>
<ul>
<li><code>peripheral_init</code> enables the peripheral clocks and configures the peripheral, but does not enable the peripheral itself. Generally returns void, but for peripherals whose initialization can fail (i.e. due to a bad parameter), some init functions will return a boolean value: <code>true</code> if successful, <code>false</code> otherwise.</li>
<li><code>peripheral_enable</code> enables the peripheral itself. Some peripherals have multiple channels; for example, the SAM L21 has two DAC channels. In these cases, the enable function takes as a parameter which instance to enable.</li>
<li><code>peripheral_disable</code> disables the peripheral. For peripherals with multiple channels, disables the channel, unless all channels are disabled in which case it disables the whole peripheral.</li>
</ul>
<p >For example, this is how you might set up the RTC peripheral, which has predefined clock defaults:</p>
<div class="fragment"><div class="line">rtc_init();</div>
<div class="line">rtc_enable();</div>
<div class="line">rtc_set_date_time(date_time);</div>
</div><!-- fragment --><p >This is how you might output an analog value on DAC channel 0 (the first DAC on the SAM L21, or the only DAC on D21):</p>
<div class="fragment"><div class="line">HAL_GPIO_A0_pmuxen(HAL_GPIO_PMUX_B);</div>
<div class="line">dac_init();</div>
<div class="line">dac_enable(0);</div>
<div class="line">dac_set_analog_value(0, 512);</div>
</div><!-- fragment --><p >This is how you would set up Timer/Counter TC1 to overflow at 500 Hz (i.e. for driving a DMA transaction):</p>
<div class="fragment"><div class="line">tc_setup(1, GENERIC_CLOCK_0, TC_PRESCALER_DIV256); <span class="comment">// 16 MHz / 256 = 62,500</span></div>
<div class="line">tc_set_wavegen(1, TC_WAVE_WAVEGEN_MFRQ); <span class="comment">// Match frequency mode, overflow at CC0</span></div>
<div class="line">tc_count16_set_cc(1, 0, 122); <span class="comment">// 62,500 / 125 = 500 Hz</span></div>
<div class="line">tc_enable(1);</div>
</div><!-- fragment --><h2><a class="anchor" id="autotoc_md3"></a>
Consistent process for flashing firmware</h2>
<p >All of these chips can function with a USB bootloader, and Gossamer is designed to work within that setup. It provides a consistent method for flashing code to a device: running <code>make &amp;&amp; make install</code> builds your application and flashes it to a device.</p>
<ul>
<li>SAM D21, L21 and L22 chips are meant to use <a href="https://github.com/adafruit/uf2-samdx1">Adafruit's UF2 bootloader</a>; just double tap Reset to enter bootloader mode.</li>
<li>SAM D11 chips can use the <a href="https://github.com/majbthrd/SAMDx1-USB-DFU-Bootloader">DFU bootloader</a>, although this is still a bit experimental.</li>
</ul>
<h2><a class="anchor" id="autotoc_md4"></a>
Simple framework for writing firmware</h2>
<p >Much like an Arduino sketch has setup and loop functions, a Gossamer application is implemented in three functions:</p>
<ul>
<li><code>app_init</code> is called after the system clocks are initialized and before anything else. This is an opportunity to change any low-level defaults like processor speed, and configure any system clocks and long-running peripherals like the RTC.</li>
<li><code>app_setup</code> is akin to the Arduino <code>setup()</code> function, and provides an opportunity to set up your application's initial state.</li>
<li><code>app_loop</code> is akin to the Arduino <code>loop()</code> function, with the difference that your application will return a boolean value indicating whether the application is prepared to enter STANDBY mode:<ul>
<li>Returning <code>false</code> here ensures that your <code>app_loop</code> will be called again immediately.</li>
<li>Returning <code>true</code> will send the microcontroller into STANDBY mode, where it will remain until woken by an interrupt. This is a fantastic way to build low power firmware.</li>
</ul>
</li>
</ul>
<h2><a class="anchor" id="autotoc_md5"></a>
Simple to get started!</h2>
<p >Boards are defined in the <code>/boards</code> directory, which sets up the target as well as predefined macros for all the pins on a given board. So, for example, this is how you get to blinky on any board with a built in LED:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="app_8h.html">app.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="delay_8h.html">delay.h</a>&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="app_8h.html#add3190cf715f513666f4be42874d91e2">app_init</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="app_8h.html#acce192accedbd296eb8d2182f8101f16">app_setup</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">    HAL_GPIO_LED_out();</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> <a class="code hl_function" href="app_8h.html#ad1cfce0ef962cd2afe2d8b2d2d13482a">app_loop</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">    HAL_GPIO_LED_toggle();</div>
<div class="line">    delay_ms(500);</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">false</span>;</div>
<div class="line">}</div>
<div class="ttc" id="aapp_8h_html"><div class="ttname"><a href="app_8h.html">app.h</a></div><div class="ttdoc">Gossamer application framework.</div></div>
<div class="ttc" id="aapp_8h_html_acce192accedbd296eb8d2182f8101f16"><div class="ttname"><a href="app_8h.html#acce192accedbd296eb8d2182f8101f16">app_setup</a></div><div class="ttdeci">void app_setup(void)</div><div class="ttdoc">A function you will implement to set up your application. The app_setup function is like setup() in A...</div></div>
<div class="ttc" id="aapp_8h_html_ad1cfce0ef962cd2afe2d8b2d2d13482a"><div class="ttname"><a href="app_8h.html#ad1cfce0ef962cd2afe2d8b2d2d13482a">app_loop</a></div><div class="ttdeci">bool app_loop(void)</div><div class="ttdoc">A function you will implement to serve as the app's main run loop. This method will be called repeate...</div></div>
<div class="ttc" id="aapp_8h_html_add3190cf715f513666f4be42874d91e2"><div class="ttname"><a href="app_8h.html#add3190cf715f513666f4be42874d91e2">app_init</a></div><div class="ttdeci">void app_init(void)</div><div class="ttdoc">A function you will implement to initialize your application state. The app_init function is called a...</div></div>
<div class="ttc" id="adelay_8h_html"><div class="ttname"><a href="delay_8h.html">delay.h</a></div><div class="ttdoc">Delay routines.</div></div>
</div><!-- fragment --><p >A more complex app, which displays "Hello" on an <a href="https://www.adafruit.com/product/5581">Oddly Specific LCD</a>, makes use of the pin mux assignment macros and the I2C peripheral:</p>
<div class="fragment"><div class="line"><span class="preprocessor">#include &quot;<a class="code" href="app_8h.html">app.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;<a class="code" href="i2c_8h.html">i2c.h</a>&quot;</span></div>
<div class="line"><span class="preprocessor">#include &quot;drivers/oso_lcd.h&quot;</span></div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="app_8h.html#add3190cf715f513666f4be42874d91e2">app_init</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">void</span> <a class="code hl_function" href="app_8h.html#acce192accedbd296eb8d2182f8101f16">app_setup</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="comment">// I2C direction set</span></div>
<div class="line">    HAL_GPIO_SDA_out();</div>
<div class="line">    HAL_GPIO_SCL_out();</div>
<div class="line">    <span class="comment">// I2C pin mux</span></div>
<div class="line">    HAL_GPIO_SDA_pmuxen(HAL_GPIO_PMUX_D);</div>
<div class="line">    HAL_GPIO_SCL_pmuxen(HAL_GPIO_PMUX_D);</div>
<div class="line">    <span class="comment">// initialize the I2C peripheral</span></div>
<div class="line">    <a class="code hl_function" href="i2c_8h.html#a5730d9445429351b9f750084c5cb5aae">i2c_init</a>();</div>
<div class="line">    <a class="code hl_function" href="i2c_8h.html#a5a1923e2271df541e858cb4e05d7b895">i2c_enable</a>();</div>
<div class="line"> </div>
<div class="line">    <span class="comment">// display text on the LCD</span></div>
<div class="line">    oso_lcd_begin();</div>
<div class="line">    oso_lcd_fill(0);</div>
<div class="line">    oso_lcd_print(<span class="stringliteral">&quot;hello&quot;</span>);</div>
<div class="line">}</div>
<div class="line"> </div>
<div class="line"><span class="keywordtype">bool</span> <a class="code hl_function" href="app_8h.html#ad1cfce0ef962cd2afe2d8b2d2d13482a">app_loop</a>(<span class="keywordtype">void</span>) {</div>
<div class="line">    <span class="keywordflow">return</span> <span class="keyword">true</span>;</div>
<div class="line">}</div>
<div class="ttc" id="ai2c_8h_html"><div class="ttname"><a href="i2c_8h.html">i2c.h</a></div><div class="ttdoc">I2C Peripheral.</div></div>
<div class="ttc" id="ai2c_8h_html_a5730d9445429351b9f750084c5cb5aae"><div class="ttname"><a href="i2c_8h.html#a5730d9445429351b9f750084c5cb5aae">i2c_init</a></div><div class="ttdeci">void i2c_init(void)</div><div class="ttdoc">Initializes the I2C peripheral.</div></div>
<div class="ttc" id="ai2c_8h_html_a5a1923e2271df541e858cb4e05d7b895"><div class="ttname"><a href="i2c_8h.html#a5a1923e2271df541e858cb4e05d7b895">i2c_enable</a></div><div class="ttdeci">void i2c_enable(void)</div><div class="ttdoc">Enables the I2C peripheral.</div></div>
</div><!-- fragment --> </div></div><!-- PageDoc -->
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.5
</small></address>
</body>
</html>
